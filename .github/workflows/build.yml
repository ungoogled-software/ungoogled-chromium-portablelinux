name: Build Linux AppImage for ungoogled-chromium
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  prep:
    name: Prepare resources
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build-image.outputs.digest }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and cache Docker image
        id: build-image
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/build.Dockerfile
          tags: chromium-builder:trixie-slim
          outputs: type=docker,dest=/tmp/chromium-builder.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/chromium-builder.tar
          retention-days: 1

      - id: build_part_00
        name: build_part_00 (prepare only)
        uses: ./.github/actions/build
        with:
          prepare-only: true
          use-existing-image: true

  build_part_01:
    name: build_part_01
    runs-on: ubuntu-latest
    needs: [prep]
    outputs:
      status: ${{ steps.build.outputs.status }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: ./.github/actions/build
        id: build
        with:
          use-existing-image: true

  build_part_02:
    name: build_part_02
    runs-on: ubuntu-latest
    if: needs.build_part_01.outputs.status != 'completed'
    needs: [build_part_01]
    outputs:
      status: ${{ steps.build.outputs.status }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: ./.github/actions/build
        id: build
        with:
          use-existing-image: true

  build_part_03:
    name: build_part_03
    runs-on: ubuntu-latest
    if: needs.build_part_02.outputs.status != 'completed'
    needs: [build_part_02]
    outputs:
      status: ${{ steps.build.outputs.status }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: ./.github/actions/build
        id: build
        with:
          use-existing-image: true

  build_part_04:
    name: build_part_04
    runs-on: ubuntu-latest
    if: needs.build_part_03.outputs.status != 'completed'
    needs: [build_part_03]
    outputs:
      status: ${{ steps.build.outputs.status }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: ./.github/actions/build
        id: build
        with:
          use-existing-image: true

  build_part_05:
    name: build_part_05
    runs-on: ubuntu-latest
    if: needs.build_part_04.outputs.status != 'completed'
    needs: [build_part_04]
    outputs:
      status: ${{ steps.build.outputs.status }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: ./.github/actions/build
        id: build
        with:
          use-existing-image: true

  build_part_06:
    name: build_part_06
    runs-on: ubuntu-latest
    if: needs.build_part_05.outputs.status != 'completed'
    needs: [build_part_05]
    outputs:
      status: ${{ steps.build.outputs.status }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: ./.github/actions/build
        id: build
        with:
          use-existing-image: true

  build_part_07:
    name: build_part_07
    runs-on: ubuntu-latest
    if: needs.build_part_06.outputs.status != 'completed'
    needs: [build_part_06]
    outputs:
      status: ${{ steps.build.outputs.status }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: ./.github/actions/build
        id: build
        with:
          use-existing-image: true

  build_part_08:
    name: build_part_08
    runs-on: ubuntu-latest
    if: needs.build_part_07.outputs.status != 'completed'
    needs: [build_part_07]
    outputs:
      status: ${{ steps.build.outputs.status }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: ./.github/actions/build
        id: build
        with:
          use-existing-image: true

  build_part_09:
    name: build_part_09
    runs-on: ubuntu-latest
    if: needs.build_part_08.outputs.status != 'completed'
    needs: [build_part_08]
    outputs:
      status: ${{ steps.build.outputs.status }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: ./.github/actions/build
        id: build
        with:
          use-existing-image: true

  build_part_10:
    name: build_part_10
    runs-on: ubuntu-latest
    if: needs.build_part_09.outputs.status != 'completed'
    needs: [build_part_09]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: ./.github/actions/build
        with:
          use-existing-image: true

  package:
    name: Package AppImage
    runs-on: ubuntu-latest
    if: ${{ !cancelled() && !failure()
            && contains(fromJSON('["success", "skipped"]'),
                        needs.build_part_10.result) }}
    needs: [build_part_10]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: ./.github/actions/package

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [package]
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'))
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: ./.github/actions/release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
